{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Workflow manifest schema",
  "description": "Workflow-level metadata, pipeline configuration, stages, cycles, and cross-workflow inputs",
  "type": "object",
  "definitions": {
    "cycleDefinition": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Human-readable cycle name"
        },
        "steps": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Ordered cycle steps"
        }
      },
      "required": ["name", "steps"],
      "additionalProperties": false
    },
    "logEntry": {
      "type": "object",
      "properties": {
        "timestamp": { "type": "string", "description": "ISO-8601 timestamp" },
        "actor": { "type": "string", "description": "Actor id or principal" },
        "type": { "type": "string", "description": "Log type (decision, assumption, session, handoff)" },
        "message": { "type": "string" },
        "artifacts": { "type": "array", "items": { "type": "string" } },
        "metadata": { "type": "object" }
      },
      "required": ["timestamp","actor","type","message"],
      "additionalProperties": true
    },
    "bypassPolicy": {
      "type": "object",
      "properties": {
        "allowed_roles": { "type": "array", "items": { "type": "string", "pattern": "^[A-Z]{1,2}-[A-Z0-9]{2,6}$" } },
        "requires_approval": { "type": "boolean", "default": true },
        "approval_count": { "type": "integer", "minimum": 1, "default": 1 },
        "audit_fields": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": false
    },
    "artifactMatch": {
      "type": "object",
      "properties": {
        "pattern": { "type": "string", "description": "Filename, artifact_id, or glob pattern" },
        "match_mode": { "type": "string", "enum": ["glob","fnmatch","regex"], "default": "glob" }
      },
      "required": ["pattern"],
      "additionalProperties": false
    },
    "directoryStructure": {
      "type": "object",
      "properties": {
        "root": {
          "type": "string",
          "description": "Root directory path"
        },
        "structure": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Subdirectory paths"
        }
      },
      "additionalProperties": false
    }
  },
  "properties": {
    "$schema": { "type": "string" },
    "workflow_id": {
      "type": "string",
      "description": "Unique workflow identifier (must match directory name)"
    },
    "name": {
      "type": "string",
      "description": "Workflow identifier (e.g., planning, implementation, research)"
    },
    "display_name": {
      "type": "string",
      "description": "Human-readable workflow name for display purposes"
    },
    "version": { "type": "string" },
    "description": { "type": "string" },
    "author": { "type": "string" },
    "created": { "type": "string" },
    "updated": { "type": "string" },
    "tags": {
      "type": "array",
      "items": { "type": "string" }
    },
    "pipeline": {
      "type": "object",
      "description": "Agent execution configuration",
      "properties": {
        "order": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Sequential list of core agent IDs in execution order"
        },
        "on_demand": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Agent IDs available on-demand (not in main pipeline)"
        },
        "parallel_groups": {
          "type": "array",
          "items": {
            "type": "array",
            "items": { "type": "string" }
          },
          "description": "Groups of agent IDs that can run in parallel"
        },
        "allow_skip": {
          "type": "boolean",
          "default": false,
          "description": "Whether agents can be skipped"
        },
        "allow_parallel": {
          "type": "boolean",
          "default": false,
          "description": "Whether parallel execution is allowed"
        }
      },
      "required": ["order"],
      "additionalProperties": false
    },
    "config": {
      "type": "object",
      "description": "Unified runtime configuration for enforcement, logging, validation, and bypass rules",
      "properties": {
        "enforcement": {
          "type": "object",
          "description": "Enforcement mode settings",
          "properties": {
            "mode": {
              "type": "string",
              "enum": ["strict", "lenient", "none"],
              "default": "strict",
              "description": "Global enforcement mode"
            },
            "checkpoint_gating": {
              "type": "string",
              "enum": ["strict", "warn", "none"],
              "default": "strict"
            },
            "handoff_gating": {
              "type": "string",
              "enum": ["strict", "warn", "none"],
              "default": "strict"
            }
          },
          "additionalProperties": false
        },
        "logging": {
          "type": "object",
          "description": "Logging requirements",
          "properties": {
            "require_session_log": { "type": "boolean", "default": true },
            "require_decision_log": { "type": "boolean", "default": true },
            "require_assumption_log": { "type": "boolean", "default": true },
            "require_handoff_log": { "type": "boolean", "default": true },
            "require_artifact_tracking": { "type": "boolean", "default": true }
          },
          "additionalProperties": false
        },
        "validation": {
          "type": "object",
          "description": "Validation settings",
          "properties": {
            "run_validation_commands": { "type": "boolean", "default": true },
            "timeout_seconds": { "type": "integer", "minimum": 1, "default": 30 }
          },
          "additionalProperties": false
        },
        "bypass": {
          "type": "object",
          "description": "Bypass audit settings",
          "properties": {
            "require_reason": { "type": "boolean", "default": true },
            "log_bypasses": { "type": "boolean", "default": true }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "stages": {
      "type": "array",
      "description": "Workflow stage definitions with agent assignments",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Stage identifier (e.g., DISCOVERY, DESIGN)"
          },
          "name": {
            "type": "string",
            "description": "Human-readable stage name"
          },
          "description": {
            "type": "string",
            "description": "What happens in this stage"
          },
          "agents": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Agent IDs assigned to this stage"
          }
        },
        "required": ["id"],
        "additionalProperties": false
      }
    },
    "cycles": {
      "type": "object",
      "description": "Named workflow cycles that agents can reference",
      "additionalProperties": { "$ref": "#/definitions/cycleDefinition" }
    },
    "input_from": {
      "type": "object",
      "description": "Cross-workflow input dependencies",
      "additionalProperties": {
        "oneOf": [
          {
            "type": "object",
            "properties": {
              "description": { "type": "string" },
              "artifacts": {
                "type": "array",
                "items": { "type": "string" },
                "description": "List of artifact filenames consumed from this workflow"
              },
              "refresh_command": {
                "type": "string",
                "description": "CLI command to refresh artifacts from source workflow"
              }
            },
            "additionalProperties": false
          },
          {
            "type": "array",
            "items": { "type": "string" },
            "description": "Simple list of artifact filenames consumed from this workflow"
          }
        ]
      }
    },
    "directories": {
      "type": "object",
      "description": "Workflow-specific directory structure for scaffolding scripts. Keys are logical names, values are path strings.",
      "additionalProperties": { "type": "string" }
    },
    "checkpoints": {
      "type": "array",
      "description": "User confirmation or validation points",
      "items": {
        "type": "object",
        "properties": {
          "after_agent": {
            "type": "string",
            "description": "Agent ID after which checkpoint occurs"
          },
          "gating": {
            "type": "string",
            "enum": ["strict","warn","none"],
            "description": "How strictly this checkpoint is enforced"
          },
          "required_artifacts": {
            "type": "array",
            "items": {
              "oneOf": [ { "type": "string" }, { "$ref": "#/definitions/artifactMatch" } ]
            },
            "description": "Artifact filenames, IDs, or patterns required before the checkpoint"
          },
          "required_logs": {
            "type": "array",
            "items": { "type": "string", "enum": ["decision","assumption","session","handoff"] },
            "description": "Log types required before checkpoint"
          },
          "bypass_policy": { "$ref": "#/definitions/bypassPolicy" },
          "owner": { "type": "string", "description": "Agent id responsible for this checkpoint", "pattern": "^[A-Z]{1,2}-[A-Z0-9]{2,6}$" },
          "validation_command": { "type": "string", "description": "Optional CLI command to run for automated validation", "pattern": "^$|^\\.\\/workflow\\b.*" },
          "timeout_seconds": { "type": "integer", "minimum": 0, "description": "Timeout for validation command in seconds" },
          "type": {
            "type": "string",
            "enum": ["human", "gate", "validation"],
            "description": "Type of checkpoint: human=manual review, gate=artifact exists, validation=automated tests"
          },
          "prompt": {
            "type": "string",
            "description": "Message to display at checkpoint"
          },
          "condition": {
            "type": "string",
            "description": "Condition that must be met for gate checkpoints"
          }
        },
        "required": ["type"],
        "additionalProperties": false
      }
    },
    "globals": {
      "type": "object",
      "description": "Global variables and rules available to all agents",
      "properties": {
        
        
      },
      "additionalProperties": true
    },
    "governance": {
      "type": "object",
      "description": "Governance rules and constraints"
    },
    "display": {
      "type": "object",
      "description": "Display and formatting preferences",
      "properties": {
        "agent_prefix": {
          "type": "string",
          "description": "ID prefix for agents (e.g., A, I, R)"
        },
        "agent_id_format": { "type": "string" },
        "orch_id": {
          "type": "string",
          "description": "Orchestrator agent ID"
        },
        "id_format": { "type": "string" },
        "focus": { "type": "string" },
        "base_rules": {
          "type": "array",
          "items": { "type": "string" }
        },
        "protocol": {
          "type": "object",
          "properties": {
            "name": { "type": "string" },
            "steps": {
              "type": "array",
              "items": { "type": "string" }
            }
          },
          "additionalProperties": false
        },
        "copilot": { "type": "object" },
        "name": { "type": "string", "description": "Optional short display name used by UIs" },
        "stage_order": { "type": "array", "items": { "type": "string" }, "description": "Preferred ordering of stages for UI presentation" },
        "frontmatter_fields": { "type": "array", "items": { "type": "string" }, "description": "List of fields to include in top-level frontmatter in priority order" }
      },
      "additionalProperties": false
    },
    "cli": {
      "type": "object",
      "description": "CLI customization options",
      "properties": {
        "extra_commands": {
          "type": "array",
          "items": { "type": "string" }
        },
        "examples": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "command": { "type": "string" },
              "description": { "type": "string" }
            },
            "required": ["command"],
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "metadata": {
      "type": "object",
      "description": "Workflow-specific extensions (tdd, gating, source_project, etc.)"
    }
  },
  "required": ["name", "display_name", "pipeline"],
  "additionalProperties": false
}
