# ==========================================================================
# YAML TEMPLATE SCHEMA REFERENCE
# ==========================================================================
# This file documents the YAML file structure for each workflow.
#
# ARCHITECTURE:
# ┌─────────────────────┐     ┌─────────────────────┐     ┌─────────────────────┐
# │  _canonical/*.json  │ ──► │  workflows/*.yaml   │ ──► │  agent_files/*.md   │
# │  (Source of Truth)  │     │  (Human-Readable)   │     │  (Agent Prompts)    │
# └─────────────────────┘     └─────────────────────┘     └─────────────────────┘
#        Phase 1                    Phase 2                     Phase 3
#   JSON Schema Valid          Denormalized View            Generated Prompts
#
# GENERATION FLOW:
#   1. Canonical JSON files validated via JSON Schema
#   2. YAML files generated from JSON (denormalized, with comments)
#   3. Agent prompt files generated from YAML
#
# For machine validation: use `manifests/_canonical_schemas/*.schema.json`
# For YAML generation: use `scripts/generation/generate_yaml.py` (Phase 2)
# For prompt generation: use `scripts/generation/generate_prompts.py` (Phase 3)
# ==========================================================================

schema_version: "2.1"
last_updated: "2025-12-04"
phases:
  phase_1: "JSON Schema Standardization (COMPLETE)"
  phase_2: "YAML Denormalization Generation (PLANNED)"
  phase_3: "Agent Prompt Generation (PLANNED)"

# ==========================================================================
# DATA OWNERSHIP MODEL
# ==========================================================================
# Each canonical file has specific ownership responsibilities:
#
# | File             | Owns                                    | Does NOT Own           |
# |------------------|-----------------------------------------|------------------------|
# | workflow.json    | Pipeline order, globals, checkpoints    | Agent/artifact details |
# | agents.json      | Agent I/O contracts (produces/consumes) | Behavioral logic       |
# | artifacts.json   | Artifact metadata, ownership            | Producer/consumer flow |
# | instructions.json| Purpose, responsibilities               | I/O (use agents.json)  |
#
# Cross-reference validation ensures consistency between files.
# ==========================================================================

# ==========================================================================
# ID FORMAT STANDARDS
# ==========================================================================
id_formats:
  agent_id:
    pattern: "^[A-Z]{1,3}-[A-Z0-9]{2,}$"
    examples: ["A-00", "A-01", "I-SEC", "R-VIZ", "W-01"]
    description: "1-3 uppercase letters, hyphen, 2+ alphanumeric chars"
  
  slug:
    pattern: "^[a-z0-9_]+$"
    examples: ["orchestrator", "scaffold", "data_steward"]
    description: "Lowercase alphanumeric with underscores, for filenames"
  
  filename:
    pattern: "^[a-z0-9_/]+\\.(md|yaml|json|bib)$"
    examples: ["project_overview.md", "specs/backend_spec.md"]
    description: "Snake_case with extension, may include subdirectories"

# ==========================================================================
# WORKFLOW.JSON SCHEMA OVERVIEW
# ==========================================================================
workflow:
  purpose: "Workflow-level metadata, pipeline configuration, and governance"
  
  required_fields:
    - name          # Unique workflow identifier (e.g., "planning")
    - pipeline      # Agent execution configuration
  
  optional_fields:
    - version       # Semantic version (e.g., "1.0.0")
    - description   # Human-readable description
    - author
    - created       # ISO date
    - updated       # ISO date
    - tags          # Categorization tags
    - display       # Formatting preferences
    - globals       # Shared rules for all agents
    - governance    # Governance configuration
    - checkpoints   # User confirmation points
    - cli           # CLI customization
  
  pipeline_structure:
    order: "List of agent IDs in execution sequence"
    parallel_groups: "Optional groups of agents that can run concurrently"
    allow_skip: "Whether agents can be skipped (default: false)"
    allow_parallel: "Enable parallel execution (default: false)"
  
  checkpoint_types:
    - human_approval  # Requires user confirmation
    - gate            # Automated condition check
    - notification    # Informational only

# ==========================================================================
# AGENTS.JSON SCHEMA OVERVIEW
# ==========================================================================
agents:
  purpose: "Agent definitions with I/O contracts"
  key_principle: "This file is the SOURCE OF TRUTH for what agents produce/consume"
  
  required_fields:
    - id            # Canonical agent ID (e.g., "A-01", "I-SEC")
    - slug          # Snake_case identifier for files
    - role          # Human-readable role title
  
  optional_fields:
    - description   # What this agent does
    - file          # Path to generated agent file
    - type          # "core" | "on_demand"
    - produces      # Artifacts this agent creates
    - consumes      # Artifacts this agent requires
    - metadata      # Free-form extensions
  
  produces_consumes_format:
    simple: "Array of filenames: ['file1.md', 'file2.md']"
    categorized: |
      Object with categories:
      {
        "core": ["main_artifact.md"],
        "domain": ["domain_specific.md"],
        "reference": ["optional_reference.md"],
        "gating": ["must_exist_before_next.md"]
      }

# ==========================================================================
# ARTIFACTS.JSON SCHEMA OVERVIEW
# ==========================================================================
artifacts:
  purpose: "Artifact registry with ownership and metadata"
  key_principle: "Every artifact has exactly ONE owner agent"
  
  required_fields:
    - filename      # Canonical filename (snake_case.md)
    - owner         # Agent ID that owns this artifact
    - type          # "file" | "directory"
  
  optional_fields:
    - description   # What this artifact contains
    - purpose       # Why this artifact exists
    - category      # "core" | "domain" | "reference" | "gating"
    - template      # Template path for generation
    - is_shared     # Multiple agents contribute (default: false)
    - is_gating     # Required before downstream agents (default: false)
    - required      # Must be produced (default: true)
    - consumed_by   # List of agent IDs that consume this
    - contributors  # List of agent IDs that contribute
    - metadata      # Free-form extensions

# ==========================================================================
# INSTRUCTIONS.JSON SCHEMA OVERVIEW
# ==========================================================================
instructions:
  purpose: "Agent behavioral instructions and responsibilities"
  key_principle: "NO I/O information here - that belongs in agents.json"
  
  required_fields:
    - id            # Must match an agent ID in agents.json
    - slug          # Must match the agent slug in agents.json
    - purpose       # What the agent achieves and its boundaries
  
  optional_fields:
    - role          # Role title (duplicates agents.json for readability)
    - responsibilities  # List of specific duties
    - workflow      # Structured workflow steps
    - boundaries    # Explicit scope boundaries
    - handoff       # Handoff protocol details
    - metadata      # Free-form extensions
  
  what_NOT_to_include:
    - ownership     # Use agents.json produces/consumes
    - inputs        # Derivable from agents.json
    - outputs       # Derivable from agents.json
    - produces      # Use agents.json
    - consumes      # Use agents.json

# ==========================================================================
# VALIDATION RULES (Phase 1 - JSON Schema Validation)
# ==========================================================================
validation:
  agent_validation:
    - "Agent IDs must match pattern: ^[A-Z]{1,2}-[A-Z0-9]{2,6}$"
    - "Slugs must be unique within workflow"
    - "Slugs must match pattern: ^[a-z0-9_]+$"
    - "pipeline.order IDs must exist in agents.json"
  
  artifact_validation:
    - "All filenames must be unique"
    - "Owner must be a valid agent ID from agents.json"
    - "Filename pattern: ^[a-z0-9_/]+\\.(md|yaml|json|bib)$"
  
  cross_reference_validation:
    - "All produces/consumes filenames must exist in artifacts.json"
    - "Instructions IDs must match agents.json IDs"
    - "Instructions slugs must match agents.json slugs"
    - "No circular dependencies in produces/consumes graph"
  
  integrity_validation:
    - "Each artifact has exactly one owner"
    - "consumed_by in artifacts matches consumes in agents (derivable)"
    - "contributors includes owner and any shared producers"

# ==========================================================================
# YAML TEMPLATE FILES (Phase 2 - Generated from Canonical JSON)
# ==========================================================================
# These YAML files are GENERATED from the canonical JSON files.
# They provide denormalized, human-readable views with comments.
# 
# Location: manifests/workflows/<workflow_name>/
# Source: manifests/_canonical/<workflow_name>/*.json
# Generator: src/agentic_workflow/generation/generate_workflow_yaml.py
# ==========================================================================

yaml_templates:
  # --------------------------------------------------------------------------
  # workflow.yaml - Workflow overview with embedded context
  # --------------------------------------------------------------------------
  workflow_yaml:
    purpose: "Consolidated workflow overview for human reference"
    generated_from:
      - workflow.json
      - agents.json  # For agent count and summary
    contains:
      - "Workflow metadata (name, version, description)"
      - "Pipeline configuration with agent sequence"
      - "Checkpoint definitions"
      - "Directory structure for scaffolding"
      - "CLI examples and commands"
      - "Agent summary table (derived)"
    example_structure: |
      # ==========================================================================
      # PLANNING WORKFLOW - Human-Readable Overview
      # Generated from: manifests/_canonical/planning/workflow.json
      # ==========================================================================
      
      name: planning
      display_name: "Planning Workflow"
      version: "1.0.0"
      
      # Agent Summary (derived from agents.json)
      agents:
        total: 15
        core: 15
        on_demand: 0
        pipeline: [A-00, A-01, ..., A-14]
      
      # Directory Structure (for scaffolding scripts)
      directories:
        root: "projects/{project_name}/"
        artifacts: "artifacts/"
        agent_files: "agent_files/"
        # ... etc
      
      # Checkpoints
      checkpoints:
        - after: A-02
          type: human
          prompt: "Architecture review complete..."

  # --------------------------------------------------------------------------
  # agents.yaml - Complete agent definitions with context
  # --------------------------------------------------------------------------
  agents_yaml:
    purpose: "Agent definitions with full I/O context and relationships"
    generated_from:
      - agents.json
      - artifacts.json  # For artifact descriptions
      - instructions.json  # For purpose/responsibilities
    contains:
      - "Agent identity (id, slug, role)"
      - "Agent type (core, on_demand, orchestrator, gating)"
      - "Produces with artifact descriptions (merged from artifacts.json)"
      - "Consumes with artifact descriptions and sources"
      - "Purpose and key responsibilities (from instructions.json)"
      - "Handoff information"
    example_structure: |
      # ==========================================================================
      # AGENTS - Planning Workflow
      # Generated from: manifests/_canonical/planning/*.json
      # ==========================================================================
      
      agents:
        - id: A-01
          slug: incubation
          role: "Project Guide & Idea Incubation"
          type: core
          
          # Purpose (from instructions.json)
          purpose: |
            Convert vague, informal ideas into a structured seed overview...
          
          # Key responsibilities (top 3 from instructions.json)
          key_responsibilities:
            - Capture and normalize raw ideas
            - Identify missing fundamentals
            - Flag ambiguity and record questions
          
          # Produces (enriched with artifact metadata)
          produces:
            core:
              - filename: seed_overview.md
                description: "Initial project vision and scope"
                is_gating: true
              - filename: incubation_log.md
                description: "Domain log for idea evolution"
          
          # Consumes (enriched with source info)
          consumes:
            core:
              - filename: project_index.md
                source: A-00
                description: "Project file registry"
          
          # Handoff
          handoff:
            next: A-02
            conditions:
              - "Readiness = HIGH"
              - "Vision clear, core problem defined"

  # --------------------------------------------------------------------------
  # artifacts.yaml - Artifact registry with producer/consumer relationships
  # --------------------------------------------------------------------------
  artifacts_yaml:
    purpose: "Complete artifact catalog with ownership and relationships"
    generated_from:
      - artifacts.json
      - agents.json  # For producer/consumer derivation
    contains:
      - "Artifact metadata (filename, description, purpose)"
      - "Ownership (owner agent)"
      - "Category and flags (is_gating, is_shared, required)"
      - "Produced by (single owner)"
      - "Consumed by (derived from agents.json)"
      - "Template path if applicable"
    example_structure: |
      # ==========================================================================
      # ARTIFACTS - Planning Workflow
      # Generated from: manifests/_canonical/planning/*.json
      # ==========================================================================
      
      artifacts:
        # --- Core Artifacts ---
        - filename: project_overview.md
          owner: A-02
          category: core
          description: "Central project vision document"
          is_gating: true
          is_shared: false
          
          # Relationships (derived)
          consumed_by: [A-03, A-04, A-05, ...]
          template: "templates/artifacts/artifact_template.md"
        
        # --- Gating Artifacts ---
        - filename: implementation_readiness_report.md
          owner: A-13
          category: gating
          description: "Final readiness assessment"
          is_gating: true
          
          consumed_by: [I-00]  # Cross-workflow consumer

  # --------------------------------------------------------------------------
  # instructions.yaml - Agent behavioral instructions (full form)
  # --------------------------------------------------------------------------
  instructions_yaml:
    purpose: "Complete agent instructions for prompt generation"
    generated_from:
      - instructions.json
      - agents.json  # For produces/consumes context
      - workflow.json  # For cycles and protocols
    contains:
      - "Complete purpose and responsibilities"
      - "Workflow steps with entry/exit conditions"
      - "In-scope and out-of-scope boundaries"
      - "Domain rules and conventions"
      - "Handoff protocol"
      - "Produces/consumes (duplicated for completeness)"
    note: "This is the primary source for agent prompt generation"
    example_structure: |
      # ==========================================================================
      # INSTRUCTIONS - Planning Workflow
      # Generated from: manifests/_canonical/planning/*.json
      # ==========================================================================
      
      instructions:
        - id: A-02
          slug: planning
          role: "Planning & Requirements Analyst"
          
          purpose: |
            Transform raw project intent into formally structured planning
            baseline: overview, requirements, constraints, assumptions.
          
          responsibilities:
            - Extract explicit, testable requirements
            - Clarify ambiguities with minimal questions
            - Categorize requirements (MVP vs future)
            - Initialize traceability matrix
          
          workflow:
            entry_conditions:
              - Seed artifacts from A-01 available
              - Readiness = HIGH from A-01
            
            steps:
              - "INTAKE: Summarize raw intent"
              - "CLARIFY: Group blocking questions"
              - "DRAFT: Build project_overview.md"
              - "REQUIREMENTS: Populate requirements_spec.md"
              # ...
            
            exit_conditions:
              - All REQ-FUNC have acceptance criteria
              - Traceability initialized
          
          boundaries:
            in_scope:
              - Requirement extraction
              - Constraint documentation
            out_of_scope:
              - Architecture decisions (A-03)
              - Data models (A-06)
          
          # I/O duplicated from agents.yaml for completeness
          produces:
            core: [project_overview.md, requirements_spec.md]
          consumes:
            core: [seed_overview.md, project_index.md]
          
          handoff:
            next: A-03
            conditions: [...]

# ==========================================================================
# WORKFLOW TYPES AND CONVENTIONS
# ==========================================================================
workflow_types:
  planning:
    prefix: "A"
    id_format: "A-00, A-01, ..., A-14"
    focus: "Software project planning artifacts"
    agent_count: "15 (1 orchestrator + 14 specialists)"
  
  implementation:
    prefix: "I"
    id_format: "I-00 to I-05 (core), I-SEC/I-DOC/I-DS/I-PERF (on-demand)"
    focus: "Code implementation and deployment"
    agent_count: "6 core + 4 on-demand"
  
  research:
    prefix: "R"
    id_format: "R-00 to R-07 (core), R-TEX/R-VIZ/R-EDIT/R-STAT (on-demand)"
    focus: "Academic research workflow"
    agent_count: "8 core + 4 on-demand"
  
  workflow-creation:
    prefix: "W"
    id_format: "W-00 to W-08"
    focus: "Creating new workflow packages"
    agent_count: "9 (guide + 8 phase agents)"

# ==========================================================================
# PHASE 2: YAML GENERATION SCRIPTS
# ==========================================================================
generation:
  script: "src/agentic_workflow/generation/generate_workflow_yaml.py"
  usage: "python3 -m agentic_workflow.generation.generate_workflow_yaml --workflow planning"
  options:
    --workflow: "Specific workflow to generate (or --all)"
    --output: "Output directory (default: manifests/workflows/)"
    --dry-run: "Preview without writing"
    --validate: "Validate generated YAML"
  
  generation_order:
    - "Load canonical JSON files"
    - "Validate against JSON schemas"
    - "Merge data for denormalization"
    - "Apply templates with comments"
    - "Write YAML files"
    - "Validate YAML output"

# ==========================================================================
# PHASE 3: AGENT PROMPT GENERATION
# ==========================================================================
prompt_generation:
  script: "scripts/generation/generate_agent_prompts.py"
  input: "manifests/workflows/<workflow>/instructions.yaml"
  output: "agent_files/<workflow>/<agent_slug>.md"
  template: "templates/_base/agent_base.md.j2"
  
  prompt_structure:
    - "Header with agent identity"
    - "Purpose and responsibilities"
    - "Workflow protocol (entry/steps/exit)"
    - "Produces/consumes frontmatter"
    - "Domain rules"
    - "CLI commands"
    - "Handoff instructions"

# ==========================================================================
# MIGRATION NOTES (Phase 1 → Phase 2)
# ==========================================================================
migration:
  from_json_to_yaml:
    tool: "src/agentic_workflow/generation/generate_workflow_yaml.py"
    note: "YAML files are generated, not manually maintained"
  
  legacy_yaml_handling:
    - "Existing YAML files will be replaced by generated versions"
    - "Any manual edits should be made to canonical JSON"
    - "Comments in generated YAML are from templates"
  
  id_normalization:
    - "A01 → A-01 (add hyphen)"
    - "R3 → R-03 (pad to 2 digits)"
    - "I-SEC stays I-SEC (already canonical)"
