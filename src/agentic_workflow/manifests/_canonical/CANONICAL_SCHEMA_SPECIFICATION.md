# Canonical Schema Specification (trimmed)

**Date:** 2025-12-04
**Status:** ADOPTED (trimmed summary)

Purpose: capture the essential design, ownership, validation, and migration guidance for the canonical JSON manifests. Large examples and raw schema excerpts were removed to keep this document focused on actionable guidance and rationale.

---

## Design Principles (summary)

- Single Responsibility: each canonical file owns one domain (workflow, agents, artifacts, instructions).
- No Redundancy: authoritative data appears in one place; other files reference by ID.
- Minimal Required Fields: schemas require only what is necessary for programmatic correctness.
- Derive Views: human-friendly YAML and agent files are generated from canonical JSON.

---

## File Ownership (high level)

- `workflow.json`: workflow identity, pipeline order, stages, globals, checkpoints, CLI guidance.
- `agents.json`: agent identity, classification, produces/consumes (I/O contracts).
- `artifacts.json`: artifact registry and authoritative owner mapping.
- `instructions.json`: behavioral guidance for agents (purpose, responsibilities, steps).

These ownership boundaries are important for cross-file validation and tooling.

---

## Validation Rules (key checks)

- workflow.pipeline.order: all agent IDs in `order` must exist in the corresponding `agents.json` for that workflow.
- agents.produces / agents.consumes: referenced filenames must exist in `artifacts.json` or be declared as cross-workflow inputs.
- artifacts.owner: each owner must be a valid agent ID defined in `agents.json`.
- instructions.id: instruction IDs must match agent IDs.
- Uniqueness: agent IDs, slugs, artifact filenames, and instruction IDs must be unique within a workflow.

Recommendation: run `scripts/validation/validate_canonical.py` as part of CI (or locally) to enforce these checks.

---

## Files Created/Modified

### Created
```
manifests/_canonical_schemas/
├── agents.schema.json
├── artifacts.schema.json
├── workflow.schema.json
└── instructions.schema.json

manifests/_canonical/
├── planning/
│   ├── agents.json
│   ├── artifacts.json
│   ├── workflow.json
│   └── instructions.json
└── implementation/
    ├── agents.json
    ├── artifacts.json
    ├── workflow.json
    └── instructions.json
```


### 2. Schema Decisions Documented

10 key design decisions recorded in `STANDARDIZATION_PLAN.md`:

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Q1. ID Format | `^[A-Z]{1,2}-[A-Z0-9]{2,6}$` | Supports prefixes + alphanumeric suffixes |
| Q2. Slug Required | Yes, in agents.json | Cross-reference key for files |
| Q3. Categories | `core`, `domain`, `reference`, `gating`, `log` | Consistent categorization |
| Q4. Ownership | In agents.json only | Single source, derivable elsewhere |
| Q5. Checkpoints | `human`, `gate`, `validation` | Simplified from human_approval |
| Q6. Cross-workflow | `input_from` with workflow ref | Explicit dependencies |
| Q7. Directories | Flexible string map | For scaffold scripts |
| Q8. Cycles | Named cycles at workflow level | Reusable patterns |
| Q9. agent_type | `core`, `on_demand`, `orchestrator`, `gating` | Agent classification |
| Q10. Metadata | Free-form object | Workflow-specific extensions |


## Lessons Learned

1. **Schema-first design** - Defining schemas before migration prevents inconsistencies
2. **Validation during migration** - Running validators after each file change catches issues early
3. **Flexible metadata** - Free-form metadata fields allow workflow-specific extensions
4. **Directories as strings** - Simple string paths work better than complex structures for scaffolding




## Checkpoints & Gating (summary)

- Checkpoints are defined in `workflow.json` and are typed as `human`, `gate`, or `validation`.
- Useful checkpoint fields: `after_agent`, `gating` (strict|warn|none), `required_artifacts`, `required_logs`, `bypass_policy`, `owner` (agent ID), `validation_command` (CLI), `timeout_seconds`.
- Use `validation_command` to call the workflow CLI so CI and automation can run deterministic checks and collect reports.

---

## Generation & Tooling (what to run)

- Validation: `scripts/validation/validate_canonical.py` — runs JSON Schema checks and cross-file referential checks.
- Generation: `scripts/generation/generate_workflow_files.py` (or `generate_yaml.py`) — produces derived YAML and agent-facing files from canonical JSON after validation.

## Design Principles

1. **Single Responsibility** — Each file owns exactly one domain of data
2. **No Redundancy** — Data appears in exactly one place; other files reference by ID
3. **Minimal Required Fields** — Only essential fields are required; everything else is optional
4. **Derivable Data** — Complex views are generated by scripts, not stored
5. **Workflow-Agnostic** — Schema fits planning, implementation, research, and future workflows

---

## File Ownership Matrix

| File | Owns | References |
|------|------|------------|
| `workflow.json` | Metadata, pipeline order, stages, globals, checkpoints | Agent IDs |
| `agents.json` | Agent identity, type, I/O contracts | Artifact filenames |
| `artifacts.json` | Artifact metadata, ownership | Agent IDs (owner) |
| `instructions.json` | Agent behavior guidance | Agent IDs, artifact filenames |

### What Gets Generated (Not Stored)

| Generated File | Source Data |
|----------------|-------------|
| `agents.yaml` | `agents.json` + comments |
| `artifacts.yaml` | `artifacts.json` + comments |
| `agent_files/*.md` | `agents.json` + `instructions.json` + templates |
| Cross-reference views | Join of agents + artifacts at runtime |


## 5. Validation Rules

### Cross-Reference Validation

```
1. workflow.pipeline.order
   ∀ id ∈ order: id ∈ agents[].id

2. agents[].produces, agents[].consumes
   ∀ filename ∈ (produces ∪ consumes): filename ∈ artifacts[].filename

3. artifacts[].owner
   ∀ owner ∈ artifacts: owner ∈ agents[].id

4. instructions[].id
   ∀ id ∈ instructions: id ∈ agents[].id

5. Uniqueness
   - agents[].id unique
   - agents[].slug unique  
   - artifacts[].filename unique
   - instructions[].id unique
```

### Format Validation

```
Agent ID:    ^[A-Z]{1,3}-[A-Z0-9]{2,}$     (A-00, I-SEC, R-01)
Slug:        ^[a-z][a-z0-9_]*$              (orchestrator, security_audit)
Filename:    ^[a-z0-9_/]+(\\.md)?$          (project_index.md, specs/)
```

---

## 2. Recommended Architecture

### 2.0 Alignment with Prior Reports

The prior reports converged on this architecture:

```
┌─────────────────────────────────────────────────────────────────┐
│              CANONICAL JSON (Source of Truth)                   │
│              manifests/_canonical/<workflow>/                   │
├─────────────────────────────────────────────────────────────────┤
│  workflow.json   │ Metadata, pipeline, globals, checkpoints    │
│  agents.json     │ Agent IDs, slugs, roles, I/O contracts      │
│  artifacts.json  │ All artifacts with ownership (AUTHORITATIVE)│
│  instructions.json│ Agent behavior (ownership is ADVISORY)     │
└──────────────────┴──────────────────────────────────────────────┘
                              │
                    validate (JSON Schema)
                              │
                    cross-reference check
                              │
                    generate (with comments)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              DERIVED YAML (Human-Readable)                      │
│              manifests/workflows/<workflow>/                    │
├─────────────────────────────────────────────────────────────────┤
│  agents.yaml, artifacts.yaml, instructions.yaml, workflow.yaml │
│  (Generated from JSON, includes comments, NOT authoritative)   │
└─────────────────────────────────────────────────────────────────┘
                              │
                    generate (agent prompts)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              GENERATED AGENT FILES                              │
│              agent_files/<workflow>/                            │
├─────────────────────────────────────────────────────────────────┤
│  A-00_orchestrator.md, A-01_incubation.md, etc.                │
│  (Generated from canonical + templates, NOT authoritative)      │
└─────────────────────────────────────────────────────────────────┘
```

### 2.1 Single Source of Truth (SSoT) Model

```
┌─────────────────────────────────────────────────────────────────┐
│                    SOURCE OF TRUTH (JSON)                       │
│              manifests/_canonical/<workflow>/                    │
├─────────────────────────────────────────────────────────────────┤
│  workflow.json   │ Metadata, pipeline, globals, checkpoints     │
│  agents.json     │ Agent IDs, slugs, roles, I/O contracts       │
│  artifacts.json  │ All artifacts with ownership, templates      │
│  instructions.json│ Agent-specific guidance (purpose, workflow) │
└──────────────────┴──────────────────────────────────────────────┘
                              │
                              │ validate + derive
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    DERIVED (YAML + Comments)                     │
│              manifests/workflows/<workflow>/                     │
├─────────────────────────────────────────────────────────────────┤
│  workflow.yaml   │ Generated from JSON with comments            │
│  agents.yaml     │ Generated from JSON with comments            │
│  artifacts.yaml  │ Generated from JSON with comments            │
│  instructions.yaml│ Generated from JSON with comments           │
└─────────────────────────────────────────────────────────────────┘
```

## 6. Generation Pipeline

```
┌─────────────────────────────────────────────────────────────────┐
│                    CANONICAL JSON (Source of Truth)             │
│                    manifests/_canonical/<workflow>/             │
├──────────────┬──────────────┬──────────────┬───────────────────┤
│ workflow.json│ agents.json  │artifacts.json│ instructions.json │
└──────┬───────┴──────┬───────┴──────┬───────┴─────────┬─────────┘
       │              │              │                 │
       │              │              │                 │
       ▼              ▼              ▼                 ▼
┌──────────────────────────────────────────────────────────────────┐
│                         VALIDATE                                 │
│        scripts/validation/validate_manifests.py                  │
│   - JSON Schema validation                                       │
│   - Cross-reference checks                                       │
│   - Format validation                                            │
└──────────────────────────────┬───────────────────────────────────┘
                               │
                               ▼
┌──────────────────────────────────────────────────────────────────┐
│                         GENERATE                                 │
│        scripts/generation/generate_workflow_files.py             │
└──────────┬───────────────────┬───────────────────┬───────────────┘
           │                   │                   │
           ▼                   ▼                   ▼
    ┌──────────────┐   ┌──────────────┐   ┌──────────────────────┐
    │  YAML Files  │   │ Agent Files  │   │   Project Files      │
    │  (with       │   │ (prompts)    │   │   (on project init)  │
    │  comments)   │   │              │   │                      │
    └──────────────┘   └──────────────┘   └──────────────────────┘
```

### Generation Scripts

| Script | Input | Output |
|--------|-------|--------|
| `generate_yaml.py` | `*.json` | `manifests/workflows/<wf>/*.yaml` |
| `generate_agent_files.py` | `agents.json` + `instructions.json` | `agent_files/<wf>/*.md` |
| `generate_project_structure.py` | All JSON + templates | `projects/<name>/` |

---



## Summary: What Goes Where

| Data | Lives In | Reason |
|------|----------|--------|
| Workflow name, version, description | `workflow.json` | Workflow identity |
| Pipeline order | `workflow.json` | Execution sequence |
| Stages | `workflow.json` | Workflow-specific phases |
| Checkpoints | `workflow.json` | Approval gates |
| Global rules | `workflow.json` | Shared across agents |
| CLI config | `workflow.json` | Command-line interface |
| Agent ID, slug, role | `agents.json` | Agent identity |
| Agent type (core/on_demand) | `agents.json` | Classification |
| Agent produces/consumes | `agents.json` | I/O contracts |
| Artifact filename | `artifacts.json` | Artifact identity |
| Artifact owner | `artifacts.json` | Single owner (authoritative) |
| Artifact metadata | `artifacts.json` | Description, purpose, flags |
| Agent purpose | `instructions.json` | What agent does |
| Agent responsibilities | `instructions.json` | Detailed duties |
| Agent workflow steps | `instructions.json` | Process steps |
| Agent boundaries | `instructions.json` | Scope limits |
| Agent domain rules | `instructions.json` | Domain-specific rules |

---

### 2.3 Validation Pipeline

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Edit JSON  │────▶│  Validate   │────▶│ Generate    │
│  (canonical)│     │  vs Schema  │     │ YAML + Docs │
└─────────────┘     └─────────────┘     └─────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ Cross-File  │
                    │ Consistency │
                    │   Check     │
                    └─────────────┘
```

**Validation Rules:**

1. **Schema validation** (JSON Schema)
2. **Cross-reference validation**:
   - All `owner` in artifacts.json must exist in agents.json
   - All `produces` items must exist in artifacts.json
   - All `consumes` items must exist in artifacts.json
   - Pipeline order must match agents.json IDs
3. **Uniqueness validation**:
   - No duplicate artifact filenames
   - No duplicate agent IDs or slugs



### Finalized Architecture

Based on analysis of all workflows and existing tooling, here is the **finalized normalized architecture**:

```
┌────────────────────────────────────────────────────────────────────┐
│                    CANONICAL JSON (Edit Here)                      │
│                    manifests/_canonical/<workflow>/                │
├─────────────────┬─────────────────┬─────────────────┬──────────────┤
│  workflow.json  │   agents.json   │ artifacts.json  │instructions. │
│                 │                 │                 │    json      │
│  • metadata     │  • id, slug     │  • filename     │  • purpose   │
│  • pipeline     │  • role         │  • owner        │  • responsi- │
│  • stages       │  • type         │  • type/category│    bilities  │
│  • checkpoints  │  • produces     │  • template     │  • workflow  │
│  • globals      │  • consumes     │  • flags        │  • boundaries│
│  • cli config   │                 │                 │  • handoff   │
└────────┬────────┴────────┬────────┴────────┬────────┴───────┬──────┘
         │                 │                 │                │
         └─────────────────┴────────┬────────┴────────────────┘
                                    │
                            ┌───────▼───────┐
                            │   VALIDATE    │
                            │   (schemas +  │
                            │   cross-refs) │
                            └───────┬───────┘
                                    │
              ┌─────────────────────┼─────────────────────┐
              │                     │                     │
              ▼                     ▼                     ▼
     ┌────────────────┐   ┌────────────────┐   ┌────────────────┐
     │  YAML Files    │   │  Agent Files   │   │ Project Init   │
     │  (human-       │   │  (prompts)     │   │ (structure)    │
     │  readable)     │   │                │   │                │
     │                │   │ agents.json +  │   │ all canonical  │
     │ workflows/<wf>/│   │ instructions   │   │ + templates    │
     └────────────────┘   └────────────────┘   └────────────────┘
```
